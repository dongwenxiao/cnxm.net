# 图片压缩工具使用指南

## 功能特性

✅ **智能压缩算法**
- 使用二分查找法自动调整质量参数
- 确保图片大小在 200KB 以内
- 保持最佳视觉质量

✅ **安全可靠**
- 自动备份所有原始图片
- 支持批量处理
- 详细的压缩日志

✅ **高性能**
- 使用 Sharp 库（基于 libvips）
- 支持 mozjpeg 高质量压缩
- 渐进式 JPEG 优化

✅ **支持格式**
- JPG / JPEG
- WebP

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 运行压缩

```bash
npm run compress-images
```

## 工作流程

1. **自动扫描** - 扫描 `images/products/` 目录下所有图片
2. **创建备份** - 将原图备份到 `images/products-backup/` 目录
3. **智能压缩** - 使用二分法找到最佳质量参数
4. **覆盖原图** - 用压缩后的图片替换原图
5. **生成报告** - 显示详细的压缩统计

## 压缩策略

### 智能质量调整
- 初始质量：90
- 最低质量：60
- 自动在 60-90 之间寻找最佳平衡点

### 尺寸限制
- 最大宽度：1920px
- 最大高度：1920px
- 保持原始宽高比

### 压缩技术
- **JPEG**: 使用 mozjpeg 引擎，渐进式编码
- **WebP**: 使用 effort 6 级压缩

## 示例输出

```
🚀 开始智能图片压缩...

目标大小: 200.00 KB
图片目录: images/products
备份目录: images/products-backup

✓ 备份: Blue Base Low Voltage Connectors/series-1-25-featured-product-2.jpg
✓ 压缩成功: Blue Base Low Voltage Connectors/series-1-25-featured-product-2.jpg
  450.23 KB → 185.67 KB (减少 58.7%, 质量 82)

========================================
           压缩完成统计报告
========================================
总图片数:     189
已处理:       156
已跳过:       33
失败:         0
----------------------------------------
原始总大小:   125.45 MB
压缩后大小:   28.92 MB
节省空间:     96.53 MB
压缩率:       76.9%
----------------------------------------
备份位置:     images/products-backup
========================================

✅ 所有图片处理完成！
```

## 配置参数

可以在 `compress-images.js` 中修改配置：

```javascript
const CONFIG = {
    targetSize: 200 * 1024,    // 目标大小 (200KB)
    maxWidth: 1920,             // 最大宽度
    maxHeight: 1920,            // 最大高度
    initialQuality: 90,         // 初始质量
    minQuality: 60,             // 最低质量
    qualityStep: 5,             // 质量步长
};
```

## 恢复原图

如果需要恢复原图：

```bash
# 删除压缩后的图片
rm -rf images/products/*

# 从备份恢复
cp -r images/products-backup/* images/products/
```

## 注意事项

⚠️ **重要提示**
1. 首次运行会创建备份，后续运行会跳过已备份的文件
2. 压缩后的图片会直接覆盖原图
3. 如果图片已经小于 200KB，会自动跳过
4. 保留备份目录直到确认压缩效果满意

## 技术细节

### 压缩算法
使用二分查找算法在质量参数空间中寻找最优解：
- 如果当前质量下文件太大 → 降低质量上限
- 如果当前质量下文件符合要求 → 提高质量下限，并保存为最佳结果
- 重复直到质量范围收敛（差值 ≤ 2）

### 为什么使用 Sharp？
- 比 ImageMagick 快 4-5 倍
- 内存占用更少
- 支持先进的压缩算法（mozjpeg）
- 更好的图片质量

## 故障排除

### 问题：Sharp 安装失败
```bash
# 清除缓存重新安装
rm -rf node_modules package-lock.json
npm install
```

### 问题：压缩后图片质量不满意
1. 提高 `minQuality` 参数（如改为 70）
2. 增加 `targetSize`（如改为 250KB）

### 问题：某些图片无法压缩到目标大小
- 这是正常的，工具会使用最低质量并给出警告
- 考虑手动调整这些图片，或增加目标大小

## 性能优化建议

1. **批量处理** - 工具已优化为批量处理，一次运行处理所有图片
2. **增量处理** - 已备份的文件不会重复备份
3. **并行处理** - 如需更快速度，可修改代码使用 Promise.all 并行处理

## 许可证

MIT

## 作者

Zhejiang Xuanmeng Electronics Co., Ltd.
